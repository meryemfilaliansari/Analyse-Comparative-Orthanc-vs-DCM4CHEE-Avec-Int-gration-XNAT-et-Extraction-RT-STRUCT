upstream dcm4chee {
    server pacs-dcm4chee:8080;
}

upstream orthanc {
    server pacs-orthanc:8042;
}

server {
    listen 9999;
    server_name _;

    # DCM4CHEE UI2 frontend
    location /dcm4chee-arc/ui2/ {
        proxy_pass http://dcm4chee;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API calls from DCM4CHEE UI -> redirect to Orthanc
    location /dcm4chee-arc/api/ {
        # Try DCM4CHEE backend first (if EAR works)
        # Otherwise, translate requests to Orthanc
        proxy_pass http://dcm4chee;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # On error, try Orthanc
        error_page 500 502 503 504 = @orthanc_fallback;
    }

    location @orthanc_fallback {
        proxy_pass http://orthanc;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Direct Orthanc UI
    location /orthanc/ {
        proxy_pass http://orthanc/ui/app/;
        proxy_set_header Host $host;
    }

    # Direct Orthanc API
    location /orthanc/api/ {
        proxy_pass http://orthanc/api/;
        proxy_set_header Host $host;
    }
}
