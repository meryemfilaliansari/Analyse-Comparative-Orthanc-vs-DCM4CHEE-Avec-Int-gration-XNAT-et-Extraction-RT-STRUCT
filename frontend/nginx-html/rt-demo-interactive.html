<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RT-STRUCT ‚Üí DICOM-SEG Live Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            color: #fff;
            overflow-x: hidden;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            padding: 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ffd700, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: glow 3s ease-in-out infinite;
        }
        @keyframes glow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
        }
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .card h2 {
            margin-bottom: 15px;
            color: #ffd700;
        }
        .workflow {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 40px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .step {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            min-width: 150px;
            position: relative;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .step-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        .arrow {
            font-size: 2em;
            color: #4ecdc4;
            animation: slide 1s ease-in-out infinite;
        }
        @keyframes slide {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(10px); }
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #ffd700;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }
        #canvas3d {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            background: rgba(0,0,0,0.5);
        }
        .btn {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.5);
        }
        .log-container {
            background: rgba(0,0,0,0.6);
            border-radius: 10px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .log-entry {
            padding: 5px;
            margin: 2px 0;
            border-left: 3px solid #4ecdc4;
            padding-left: 10px;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .roi-list {
            list-style: none;
        }
        .roi-item {
            background: rgba(255,255,255,0.1);
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid;
            transition: all 0.3s;
        }
        .roi-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(10px);
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .demo-controls {
            text-align: center;
            margin: 30px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }
        .status-online { background: #4caf50; }
        .status-offline { background: #f44336; }
        .canvas-container {
            position: relative;
            margin: 20px 0;
        }
        .chart-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ RT-STRUCT ‚Üí DICOM-SEG Live Demo</h1>
            <p class="subtitle">Voxelisation en temps r√©el ‚Ä¢ Analyse automatique ‚Ä¢ IA-Ready</p>
        </div>

        <!-- Workflow Animation -->
        <div class="workflow">
            <div class="step">
                <div class="step-icon">üì•</div>
                <strong>CT + RT-STRUCT</strong><br>
                <small>Upload DICOM</small>
            </div>
            <div class="arrow">‚Üí</div>
            <div class="step">
                <div class="step-icon">üîç</div>
                <strong>D√©tection Auto</strong><br>
                <small>Webhook Orthanc</small>
            </div>
            <div class="arrow">‚Üí</div>
            <div class="step">
                <div class="step-icon">üêç</div>
                <strong>RT-Utils</strong><br>
                <small>Voxelisation</small>
            </div>
            <div class="arrow">‚Üí</div>
            <div class="step">
                <div class="step-icon">üßÆ</div>
                <strong>ITK/VTK</strong><br>
                <small>Post-processing</small>
            </div>
            <div class="arrow">‚Üí</div>
            <div class="step">
                <div class="step-icon">üíæ</div>
                <strong>DICOM-SEG</strong><br>
                <small>Export√©</small>
            </div>
        </div>

        <!-- Stats Dashboard -->
        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="statStructures">0</div>
                <div class="stat-label">Structures Trait√©es</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statVoxels">0</div>
                <div class="stat-label">Voxels Analys√©s</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statVolume">0</div>
                <div class="stat-label">Volume Total (cm¬≥)</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statProcessing">0ms</div>
                <div class="stat-label">Temps Traitement</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid">
            <!-- Services Status -->
            <div class="card">
                <h2>üîß √âtat des Services</h2>
                <div id="serviceStatus"></div>
            </div>

            <!-- Live Processing -->
            <div class="card">
                <h2>‚ö° Traitement en Direct</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
                </div>
                <div class="log-container" id="logContainer"></div>
            </div>

            <!-- ROI Analysis -->
            <div class="card">
                <h2>üéØ Structures D√©tect√©es (ROIs)</h2>
                <ul class="roi-list" id="roiList"></ul>
            </div>

            <!-- Volume Chart -->
            <div class="card">
                <h2>üìä Volumes par Structure</h2>
                <canvas id="volumeChart"></canvas>
            </div>

            <!-- 3D Visualization -->
            <div class="card" style="grid-column: span 2;">
                <h2>üßä Visualisation 3D (Simulation)</h2>
                <div id="canvas3d"></div>
            </div>
        </div>

        <!-- Demo Controls -->
        <div class="demo-controls">
            <button class="btn" onclick="startDemo()">üöÄ Lancer D√©mo RT-STRUCT</button>
            <button class="btn" onclick="processGTV()">üéØ Analyser GTV</button>
            <button class="btn" onclick="processCTV()">üìç Analyser CTV</button>
            <button class="btn" onclick="resetDemo()">üîÑ R√©initialiser</button>
        </div>
    </div>

    <script>
        // Services Status Check
        const services = [
            { name: 'RT-STRUCT Processor', url: 'http://localhost:5001/health', port: 5001 },
            { name: 'ITK/VTK Service', url: 'http://localhost:5002/health', port: 5002 },
            { name: 'Orchestrator', url: 'http://localhost:5003/health', port: 5003 }
        ];

        let structureCount = 0;
        let voxelCount = 0;
        let volumeTotal = 0;
        let processingTime = 0;
        let volumeChart;

        // Initialize
        async function init() {
            await checkServices();
            initCharts();
            init3DVisualization();
            addLog('‚úÖ Syst√®me initialis√© et pr√™t', 'success');
        }

        async function checkServices() {
            const container = document.getElementById('serviceStatus');
            container.innerHTML = '';
            
            for (const service of services) {
                const status = document.createElement('div');
                status.style.cssText = 'padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 5px;';
                
                try {
                    const response = await fetch(service.url);
                    const data = await response.json();
                    status.innerHTML = `
                        <span class="status-indicator status-online"></span>
                        <strong>${service.name}</strong>
                        <br><small style="opacity: 0.7;">Port ${service.port} ‚Ä¢ ${data.status}</small>
                    `;
                } catch (error) {
                    status.innerHTML = `
                        <span class="status-indicator status-offline"></span>
                        <strong>${service.name}</strong>
                        <br><small style="opacity: 0.7;">Offline</small>
                    `;
                }
                container.appendChild(status);
            }
        }

        function initCharts() {
            const ctx = document.getElementById('volumeChart');
            volumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Volume (cm¬≥)',
                        data: [],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function init3DVisualization() {
            const container = document.getElementById('canvas3d');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, container.clientWidth / 400, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            
            renderer.setSize(container.clientWidth, 400);
            container.appendChild(renderer.domElement);
            
            // Add rotating cubes representing structures
            const geometries = [
                new THREE.BoxGeometry(1, 1, 1),
                new THREE.SphereGeometry(0.7, 32, 32),
                new THREE.ConeGeometry(0.7, 1.5, 32)
            ];
            
            const materials = [
                new THREE.MeshPhongMaterial({ color: 0xff6b6b, transparent: true, opacity: 0.7 }),
                new THREE.MeshPhongMaterial({ color: 0x4ecdc4, transparent: true, opacity: 0.7 }),
                new THREE.MeshPhongMaterial({ color: 0xffd700, transparent: true, opacity: 0.7 })
            ];
            
            const meshes = [];
            geometries.forEach((geo, i) => {
                const mesh = new THREE.Mesh(geo, materials[i]);
                mesh.position.x = (i - 1) * 2;
                scene.add(mesh);
                meshes.push(mesh);
            });
            
            const light = new THREE.PointLight(0xffffff, 1, 100);
            light.position.set(5, 5, 5);
            scene.add(light);
            
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            
            camera.position.z = 5;
            
            function animate() {
                requestAnimationFrame(animate);
                meshes.forEach((mesh, i) => {
                    mesh.rotation.x += 0.01 * (i + 1);
                    mesh.rotation.y += 0.01 * (i + 1);
                });
                renderer.render(scene, camera);
            }
            animate();
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.style.borderLeftColor = type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#4ecdc4';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStats() {
            document.getElementById('statStructures').textContent = structureCount;
            document.getElementById('statVoxels').textContent = voxelCount.toLocaleString();
            document.getElementById('statVolume').textContent = volumeTotal.toFixed(2);
            document.getElementById('statProcessing').textContent = processingTime + 'ms';
        }

        function updateProgress(percent) {
            const bar = document.getElementById('progressBar');
            bar.style.width = percent + '%';
            bar.textContent = percent + '%';
        }

        async function startDemo() {
            addLog('üöÄ D√©marrage du workflow RT-STRUCT ‚Üí DICOM-SEG');
            updateProgress(0);
            
            // Simulate upload
            await sleep(500);
            addLog('üì• Upload CT series (120 slices)');
            updateProgress(20);
            
            await sleep(500);
            addLog('üì• Upload RT-STRUCT (5 ROIs: GTV, CTV, Poumon_D, Poumon_G, Coeur)');
            updateProgress(40);
            
            await sleep(500);
            addLog('üîç Webhook Orthanc d√©clench√©');
            updateProgress(50);
            
            await sleep(700);
            addLog('üêç RT-Utils: Extraction des contours...');
            updateProgress(60);
            
            await sleep(800);
            addLog('üßÆ ITK/VTK: Voxelisation 3D en cours...');
            updateProgress(75);
            
            // Simulate ROI processing
            const rois = [
                { name: 'GTV', volume: 45.3, voxels: 12543, color: '#ff6b6b' },
                { name: 'CTV', volume: 125.7, voxels: 34782, color: '#4ecdc4' },
                { name: 'Poumon Droit', volume: 1832.4, voxels: 506871, color: '#ffd700' },
                { name: 'Poumon Gauche', volume: 1654.2, voxels: 457483, color: '#95e1d3' },
                { name: 'Coeur', volume: 612.5, voxels: 169375, color: '#f38181' }
            ];
            
            const roiList = document.getElementById('roiList');
            roiList.innerHTML = '';
            
            volumeChart.data.labels = [];
            volumeChart.data.datasets[0].data = [];
            
            for (const roi of rois) {
                await sleep(300);
                addLog(`‚úÖ ROI "${roi.name}": ${roi.voxels.toLocaleString()} voxels, ${roi.volume.toFixed(1)} cm¬≥`);
                
                const item = document.createElement('li');
                item.className = 'roi-item';
                item.style.borderLeftColor = roi.color;
                item.innerHTML = `
                    <strong>${roi.name}</strong>
                    <br><small>${roi.volume.toFixed(1)} cm¬≥ ‚Ä¢ ${roi.voxels.toLocaleString()} voxels</small>
                `;
                roiList.appendChild(item);
                
                volumeChart.data.labels.push(roi.name);
                volumeChart.data.datasets[0].data.push(roi.volume);
                volumeChart.update();
                
                structureCount++;
                voxelCount += roi.voxels;
                volumeTotal += roi.volume;
            }
            
            await sleep(500);
            addLog('üíæ G√©n√©ration DICOM-SEG...');
            updateProgress(90);
            
            await sleep(500);
            addLog('üì§ Upload vers Orthanc Admin');
            updateProgress(95);
            
            await sleep(500);
            processingTime = 3450;
            updateStats();
            updateProgress(100);
            addLog('‚úÖ Workflow termin√© avec succ√®s!', 'success');
        }

        async function processGTV() {
            addLog('üéØ Traitement GTV (Gross Tumor Volume)');
            structureCount++;
            voxelCount += 12543;
            volumeTotal += 45.3;
            processingTime = 850;
            updateStats();
            addLog('‚úÖ GTV trait√©: 45.3 cm¬≥', 'success');
        }

        async function processCTV() {
            addLog('üìç Traitement CTV (Clinical Target Volume)');
            structureCount++;
            voxelCount += 34782;
            volumeTotal += 125.7;
            processingTime = 1240;
            updateStats();
            addLog('‚úÖ CTV trait√©: 125.7 cm¬≥', 'success');
        }

        function resetDemo() {
            structureCount = 0;
            voxelCount = 0;
            volumeTotal = 0;
            processingTime = 0;
            updateStats();
            updateProgress(0);
            document.getElementById('roiList').innerHTML = '';
            document.getElementById('logContainer').innerHTML = '';
            volumeChart.data.labels = [];
            volumeChart.data.datasets[0].data = [];
            volumeChart.update();
            addLog('üîÑ D√©mo r√©initialis√©e');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Auto-refresh services every 30s
        setInterval(checkServices, 30000);

        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>
